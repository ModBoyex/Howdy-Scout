const demo_images = {
	"118": "https://i.imgur.com/A0CFArb.jpeg",
	"1477": "https://i.imgur.com/aOSnrdQ.jpeg",
	"231": "https://i.imgur.com/ocrUE94.jpeg",
	"2468": "https://i.imgur.com/NhRU6Bh.jpeg",
	"2582": "https://i.imgur.com/Q94yjWH.jpeg"
}
function getImages() {
	return demo_images
}
async function updateScoutingData() {
	//TODO: put code here to get scouting data from website
	return {
		data: [
			{
				primary_key: "118-2024txcmp1_qm1-blue1-Saragh E",
				frc_team: "118",
				event_key: "2024txcmp1",
				match_key: "2024txcmp1_qm1",
				driver_station: "blue1",
				comp_level: "qm",
				match_number: 1,
				auto_moved: "Yes",
				auto_amp: 0,
				auto_speaker: 2,
				auto_midfield_pickups: 1,
				tele_amp: 3,
				tele_amp_miss: 0,
				tele_speaker: 2,
				tele_speaker_miss: 5,
				tele_trap: 1,
				tele_climb: "Climb",
				defender_rating: 0,
				mech_failure: " ",
				scouted_by: "Saragh E",
				tele_assist: 4,
			},
			{
				primary_key: "118-2024txcmp1_qm18-red3-Ryan R",
				frc_team: "118",
				event_key: "2024txcmp1",
				match_key: "2024txcmp1_qm18",
				driver_station: "red3",
				comp_level: "qm",
				match_number: 18,
				auto_moved: "Yes",
				auto_amp: 0,
				auto_speaker: 3,
				auto_midfield_pickups: 1,
				tele_amp: 5,
				tele_amp_miss: 0,
				tele_speaker: 6,
				tele_speaker_miss: 1,
				tele_trap: 1,
				tele_climb: "Climb",
				defender_rating: 0,
				mech_failure: " ",
				scouted_by: "Ryan R",
				tele_assist: 1,
			},
			{
				primary_key: "118-2024txcmp1_qm24-blue1-Chance P",
				frc_team: "118",
				event_key: "2024txcmp1",
				match_key: "2024txcmp1_qm24",
				driver_station: "blue1",
				comp_level: "qm",
				match_number: 24,
				auto_moved: "Yes",
				auto_amp: 0,
				auto_speaker: 4,
				auto_midfield_pickups: 2,
				tele_amp: 7,
				tele_amp_miss: 0,
				tele_speaker: 6,
				tele_speaker_miss: 1,
				tele_trap: 1,
				tele_climb: "Climb",
				defender_rating: 0,
				mech_failure: " ",
				scouted_by: "Chance P",
				tele_assist: 0,
			},
			{
				primary_key: "118-2024txcmp1_qm40-red3-Josh W",
				frc_team: "118",
				event_key: "2024txcmp1",
				match_key: "2024txcmp1_qm40",
				driver_station: "red3",
				comp_level: "qm",
				match_number: 40,
				auto_moved: "Yes",
				auto_amp: 0,
				auto_speaker: 1,
				auto_midfield_pickups: 1,
				tele_amp: 5,
				tele_amp_miss: 0,
				tele_speaker: 5,
				tele_speaker_miss: 1,
				tele_trap: 1,
				tele_climb: "Climb",
				defender_rating: 0,
				mech_failure: " ",
				scouted_by: "Josh W",
				tele_assist: 2,
			},
			{
				primary_key: "118-2024txcmp1_qm50-red3-Hitu C",
				frc_team: "118",
				event_key: "2024txcmp1",
				match_key: "2024txcmp1_qm50",
				driver_station: "red3",
				comp_level: "qm",
				match_number: 50,
				auto_moved: "Yes",
				auto_amp: 0,
				auto_speaker: 3,
				auto_midfield_pickups: 1,
				tele_amp: 5,
				tele_amp_miss: 0,
				tele_speaker: 8,
				tele_speaker_miss: 1,
				tele_trap: 1,
				tele_climb: "Climb",
				defender_rating: 3,
				mech_failure: " ",
				scouted_by: "Hitu C",
				tele_assist: 2,
			},
			{
				primary_key: "118-2024txcmp1_qm58-red1-Shelby M",
				frc_team: "118",
				event_key: "2024txcmp1",
				match_key: "2024txcmp1_qm58",
				driver_station: "red1",
				comp_level: "qm",
				match_number: 58,
				auto_moved: "Yes",
				auto_amp: 0,
				auto_speaker: 2,
				auto_midfield_pickups: 1,
				tele_amp: 0,
				tele_amp_miss: 0,
				tele_speaker: 4,
				tele_speaker_miss: 0,
				tele_trap: 1,
				tele_climb: "Climb",
				defender_rating: 0,
				mech_failure: " ",
				scouted_by: "Shelby M",
				tele_assist: 0,
			},
			{
				primary_key: "118-2024txcmp1_qm63-red1-Victoria H",
				frc_team: "118",
				event_key: "2024txcmp1",
				match_key: "2024txcmp1_qm63",
				driver_station: "red1",
				comp_level: "qm",
				match_number: 63,
				auto_moved: "Yes",
				auto_amp: 0,
				auto_speaker: 3,
				auto_midfield_pickups: 2,
				tele_amp: 2,
				tele_amp_miss: 0,
				tele_speaker: 0,
				tele_speaker_miss: 0,
				tele_trap: 1,
				tele_climb: "Climb",
				defender_rating: 0,
				mech_failure: " ",
				scouted_by: "Victoria H",
				tele_assist: 0,
			},
			{
				primary_key: "118-2024txcmp1_qm70-red2-Clyde D",
				frc_team: "118",
				event_key: "2024txcmp1",
				match_key: "2024txcmp1_qm70",
				driver_station: "red2",
				comp_level: "qm",
				match_number: 70,
				auto_moved: " ",
				auto_amp: 0,
				auto_speaker: 1,
				auto_midfield_pickups: 0,
				tele_amp: 0,
				tele_amp_miss: 0,
				tele_speaker: 11,
				tele_speaker_miss: 0,
				tele_trap: 1,
				tele_climb: "Climb",
				defender_rating: 0,
				mech_failure: " ",
				scouted_by: "Clyde D",
				tele_assist: 5,
			},
			{
				primary_key: "118-2024txcmp1_qm78-blue2-Shelby M",
				frc_team: "118",
				event_key: "2024txcmp1",
				match_key: "2024txcmp1_qm78",
				driver_station: "blue2",
				comp_level: "qm",
				match_number: 78,
				auto_moved: "Yes",
				auto_amp: 0,
				auto_speaker: 2,
				auto_midfield_pickups: 1,
				tele_amp: 0,
				tele_amp_miss: 0,
				tele_speaker: 4,
				tele_speaker_miss: 0,
				tele_trap: 0,
				tele_climb: " ",
				defender_rating: 0,
				mech_failure: " ",
				scouted_by: "Shelby M",
				tele_assist: 0,
			},
			{
				primary_key: "118-2024txcmp1_qm83-blue2-Shelby M",
				frc_team: "118",
				event_key: "2024txcmp1",
				match_key: "2024txcmp1_qm83",
				driver_station: "blue2",
				comp_level: "qm",
				match_number: 83,
				auto_moved: "Yes",
				auto_amp: 0,
				auto_speaker: 1,
				auto_midfield_pickups: 2,
				tele_amp: 9,
				tele_amp_miss: 0,
				tele_speaker: 8,
				tele_speaker_miss: 2,
				tele_trap: 0,
				tele_climb: "Climb",
				defender_rating: 0,
				mech_failure: " ",
				scouted_by: "Shelby M",
				tele_assist: 0,
			},
			{
				"primary_key": "1477-2024txcmp1_qm10-red3-Carter N",
				"frc_team": "1477",
				"event_key": "2024txcmp1",
				"match_key": "2024txcmp1_qm10",
				"driver_station": "red3",
				"comp_level": "qm",
				"match_number": 10,
				"auto_moved": "Yes",
				"auto_amp": 0,
				"auto_speaker": 3,
				"auto_midfield_pickups": 0,
				"tele_amp": 0,
				"tele_amp_miss": 0,
				"tele_speaker": 0,
				"tele_speaker_miss": 0,
				"tele_trap": 0,
				"tele_climb": "Climb",
				"defender_rating": 0,
				"mech_failure": " ",
				"scouted_by": "Carter N",
				"tele_assist": 9
			  },
			  {
				"primary_key": "1477-2024txcmp1_qm20-blue1-Clyde D",
				"frc_team": "1477",
				"event_key": "2024txcmp1",
				"match_key": "2024txcmp1_qm20",
				"driver_station": "blue1",
				"comp_level": "qm",
				"match_number": 20,
				"auto_moved": "No",
				"auto_amp": 0,
				"auto_speaker": 4,
				"auto_midfield_pickups": 1,
				"tele_amp": 7,
				"tele_amp_miss": 0,
				"tele_speaker": 5,
				"tele_speaker_miss": 0,
				"tele_trap": 0,
				"tele_climb": "Climb",
				"defender_rating": 0,
				"mech_failure": " ",
				"scouted_by": "Clyde D",
				"tele_assist": 2
			  },
			  {
				"primary_key": "1477-2024txcmp1_qm27-red2-Jared CF",
				"frc_team": "1477",
				"event_key": "2024txcmp1",
				"match_key": "2024txcmp1_qm27",
				"driver_station": "red2",
				"comp_level": "qm",
				"match_number": 27,
				"auto_moved": "Yes",
				"auto_amp": 0,
				"auto_speaker": 2,
				"auto_midfield_pickups": 1,
				"tele_amp": 2,
				"tele_amp_miss": 0,
				"tele_speaker": 11,
				"tele_speaker_miss": 0,
				"tele_trap": 0,
				"tele_climb": "Harmony",
				"defender_rating": 0,
				"mech_failure": " ",
				"scouted_by": "Jared CF",
				"tele_assist": 2
			  },
			  {
				"primary_key": "1477-2024txcmp1_qm3-blue2-Shelby M",
				"frc_team": "1477",
				"event_key": "2024txcmp1",
				"match_key": "2024txcmp1_qm3",
				"driver_station": "blue2",
				"comp_level": "qm",
				"match_number": 3,
				"auto_moved": "Yes",
				"auto_amp": 0,
				"auto_speaker": 4,
				"auto_midfield_pickups": 0,
				"tele_amp": 1,
				"tele_amp_miss": 0,
				"tele_speaker": 6,
				"tele_speaker_miss": 4,
				"tele_trap": 0,
				"tele_climb": "Climb",
				"defender_rating": 0,
				"mech_failure": " ",
				"scouted_by": "Shelby M",
				"tele_assist": 0
			  },
			  {
				"primary_key": "1477-2024txcmp1_qm37-red1-Carter N",
				"frc_team": "1477",
				"event_key": "2024txcmp1",
				"match_key": "2024txcmp1_qm37",
				"driver_station": "red1",
				"comp_level": "qm",
				"match_number": 37,
				"auto_moved": "Yes",
				"auto_amp": 0,
				"auto_speaker": 2,
				"auto_midfield_pickups": 1,
				"tele_amp": 1,
				"tele_amp_miss": 0,
				"tele_speaker": 2,
				"tele_speaker_miss": 0,
				"tele_trap": 0,
				"tele_climb": "Climb",
				"defender_rating": 0,
				"mech_failure": " ",
				"scouted_by": "Carter N",
				"tele_assist": 11
			  },
			  {
				"primary_key": "1477-2024txcmp1_qm49-blue3-Chance P",
				"frc_team": "1477",
				"event_key": "2024txcmp1",
				"match_key": "2024txcmp1_qm49",
				"driver_station": "blue3",
				"comp_level": "qm",
				"match_number": 49,
				"auto_moved": "Yes",
				"auto_amp": 0,
				"auto_speaker": 3,
				"auto_midfield_pickups": 0,
				"tele_amp": 1,
				"tele_amp_miss": 1,
				"tele_speaker": 6,
				"tele_speaker_miss": 0,
				"tele_trap": 1,
				"tele_climb": "Climb",
				"defender_rating": 1,
				"mech_failure": " ",
				"scouted_by": "Chance P",
				"tele_assist": 3
			  },
			  {
				"primary_key": "1477-2024txcmp1_qm54-blue2-Benjamin H",
				"frc_team": "1477",
				"event_key": "2024txcmp1",
				"match_key": "2024txcmp1_qm54",
				"driver_station": "blue2",
				"comp_level": "qm",
				"match_number": 54,
				"auto_moved": " ",
				"auto_amp": 0,
				"auto_speaker": 3,
				"auto_midfield_pickups": 0,
				"tele_amp": 5,
				"tele_amp_miss": 1,
				"tele_speaker": 4,
				"tele_speaker_miss": 0,
				"tele_trap": 0,
				"tele_climb": "Climb",
				"defender_rating": 0,
				"mech_failure": " ",
				"scouted_by": "Benjamin H",
				"tele_assist": 3
			  },
			  {
				"primary_key": "1477-2024txcmp1_qm60-blue3-Kai G",
				"frc_team": "1477",
				"event_key": "2024txcmp1",
				"match_key": "2024txcmp1_qm60",
				"driver_station": "blue3",
				"comp_level": "qm",
				"match_number": 60,
				"auto_moved": "Yes",
				"auto_amp": 0,
				"auto_speaker": 5,
				"auto_midfield_pickups": 0,
				"tele_amp": 1,
				"tele_amp_miss": 0,
				"tele_speaker": 6,
				"tele_speaker_miss": 0,
				"tele_trap": 0,
				"tele_climb": "Harmony",
				"defender_rating": 0,
				"mech_failure": " ",
				"scouted_by": "Kai G",
				"tele_assist": 5
			  },
			  {
				"primary_key": "1477-2024txcmp1_qm66-blue1-Hitu C",
				"frc_team": "1477",
				"event_key": "2024txcmp1",
				"match_key": "2024txcmp1_qm66",
				"driver_station": "blue1",
				"comp_level": "qm",
				"match_number": 66,
				"auto_moved": "Yes",
				"auto_amp": 0,
				"auto_speaker": 4,
				"auto_midfield_pickups": 1,
				"tele_amp": 5,
				"tele_amp_miss": 6,
				"tele_speaker": 4,
				"tele_speaker_miss": 1,
				"tele_trap": 0,
				"tele_climb": "Climb",
				"defender_rating": 1,
				"mech_failure": " ",
				"scouted_by": "Hitu C",
				"tele_assist": 0
			  },
			  {
				"primary_key": "1477-2024txcmp1_qm73-red3-Benjamin H",
				"frc_team": "1477",
				"event_key": "2024txcmp1",
				"match_key": "2024txcmp1_qm73",
				"driver_station": "red3",
				"comp_level": "qm",
				"match_number": 73,
				"auto_moved": " ",
				"auto_amp": 0,
				"auto_speaker": 5,
				"auto_midfield_pickups": 0,
				"tele_amp": 4,
				"tele_amp_miss": 0,
				"tele_speaker": 5,
				"tele_speaker_miss": 0,
				"tele_trap": 1,
				"tele_climb": "Climb",
				"defender_rating": 0,
				"mech_failure": " ",
				"scouted_by": "Benjamin H",
				"tele_assist": 2
			  },
			  {
				"primary_key": "1477-2024txcmp1_qm80-red1-Chance P",
				"frc_team": "1477",
				"event_key": "2024txcmp1",
				"match_key": "2024txcmp1_qm80",
				"driver_station": "red1",
				"comp_level": "qm",
				"match_number": 80,
				"auto_moved": "Yes",
				"auto_amp": 0,
				"auto_speaker": 1,
				"auto_midfield_pickups": 1,
				"tele_amp": 4,
				"tele_amp_miss": 2,
				"tele_speaker": 4,
				"tele_speaker_miss": 0,
				"tele_trap": 0,
				"tele_climb": "Climb",
				"defender_rating": 0,
				"mech_failure": " ",
				"scouted_by": "Chance P",
				"tele_assist": 1
			  }
		],
	};
}

function getTeamScoutData(team_num) {
	filtered_data = scouting_data.data.filter(
		(team) => team.frc_team == team_num,
	);
	return filtered_data;
}

function setup_graph(scouting_data, team_number, selecting) {
	if(selecting) {
		var data = [];
		var color_map = {}
		for (var i = 0; i < selected_teams.length; i++) {
			color_map[selected_teams[i]] = color_discrete_sequence[i]
		}

		filtered_scouting_data = scouting_data["data"].filter((e) => e["frc_team"] == team_number && e["event_key"] == event_key)
		filtered_scouting_data.sort((a, b) => a.match_number - b.match_number)

		console.log(filtered_scouting_data)
		const scouters = filtered_scouting_data.map((e) => e["scouted_by"])
		const matchNumbers = filtered_scouting_data.map((e) => e["match_numbers"])
		const hoverText = filtered_scouting_data.map((e) => 
			"<b>Scouter:</b> " + e["scouted_by"] + "<br>" + 
			"<b>Match Number:</b> " + e["match_number"] + "<br>" + 
			`<b>${current_stat}:</b> ${e[current_stat]}`
		)
		var trace = {
			x: [],
			y: [],
			text: hoverText, 
			//customdata: {"scouters": scouters, "matchNumbers": matchNumbers},
			//hovertemplate:
			//	"<i>Notes</i>: %{y}" + "<br><i>Scouter</i>: %{customdata.scouters}</br>",
			name: team_number,
			type: "line",
			marker: {
				color: color_map[team_number]
			}
		};

		for (const key in filtered_scouting_data) {
			obj = filtered_scouting_data[key]
			trace.y.push(obj[current_stat]);
			console.log(current_stat)
			trace.text.push(obj[current_stat]);
		}
		trace.x = [...Array(filtered_scouting_data.length).keys()];

		const trend_trace = getTrendline(trace.x, trace.y, team_number, color_map[team_number])

		data.push(trace, trend_trace);

		if (plot.data) {
			data = [...plot.data, ...data]
			Plotly.react(plot, data, layout, {displayModeBar:false});
		} else {
			Plotly.newPlot(plot, data, layout, {displayModeBar:false});
		}
	} else {
		const newData = plot.data.filter((trace) => !trace["name"].match(team_number))

		Plotly.react(plot, newData, layout, {displayModeBar:false});
	}
}
  
function updateStatGraph(team_number, selecting) {
	setup_graph(scouting_data, team_number, selecting);
}

function changeStatGraph() {
	if (this.value && this.value != current_stat) {
		current_stat  = this.value;

		Plotly.react(plot, [], layout)

		selected_teams.forEach((team) => {
			updateStatGraph(team, true)
		})
	} 

}

async function getEntries() {
	var key_list = [];
	for (const [key, value] of Object.entries(scouting_data.data[0])) {
		if (typeof value == typeof 0 && key != "match_number") {
			key_list.push(key);
		}
	}
	return key_list;
}

async function setupStatPicker() {
	scouting_data = await updateScoutingData();
	scout_stat_picker.firstChild.remove();
	for (const [key, value] of Object.entries(scouting_data.data[0])) {
		if (typeof value == typeof 0 && key != "match_number") {
			clone = scout_stat_template.cloneNode();
			clone.textContent = key;
			clone.value = key
			scout_stat_picker.appendChild(clone);
		}
	}
}

function clearPlot () {
	Plotly.purge(plot)
	selected_teams = []
	scout_stat_picker.value = "none"
	current_stat = undefined
}

function linearRegression(x,y){
	var lr = {};
	var n = y.length;
	var sum_x = 0;
	var sum_y = 0;
	var sum_xy = 0;
	var sum_xx = 0;
	var sum_yy = 0;

	for (var i = 0; i < y.length; i++) {

		sum_x += x[i];
		sum_y += y[i];
		sum_xy += (x[i]*y[i]);
		sum_xx += (x[i]*x[i]);
		sum_yy += (y[i]*y[i]);
	} 

	lr['sl'] = (n * sum_xy - sum_x * sum_y) / (n*sum_xx - sum_x * sum_x);
	lr['off'] = (sum_y - lr.sl * sum_x)/n;
	lr['r2'] = Math.pow((n*sum_xy - sum_x*sum_y)/Math.sqrt((n*sum_xx-sum_x*sum_x)*(n*sum_yy-sum_y*sum_y)),2);

	return lr;
}

function getTrendline(x,y,team_number, color) {
	var x_data_64 = x;
	var y_data_64 = y;
	var lr = linearRegression(x_data_64, y_data_64);

	var fit_from = Math.min(...x_data_64)
	var fit_to = Math.max(...x_data_64)

	var trace = {
		x: x_data_64,
		y: y_data_64,
		name: "Scatter"
	};  

	var fit = {
		x: [fit_from, fit_to],
		y: [fit_from*lr.sl+lr.off, fit_to*lr.sl+lr.off],
		mode: 'lines',
		name: "trend: " + team_number,
		showlegend: false,
		marker: {
			color: color,
		},
		line: {
			dash: "dot",
			width:4,
		},
		opacity: 0.6
	};

	//console.log(fit);
	return fit
}